name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            name: intel
          - arch: arm64
            name: apple_silicon
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Build for ${{ matrix.name }}
      run: |
        APP_NAME="O&M Game Room"
        VERSION=${GITHUB_REF#refs/tags/v}
        
        # Create app bundle
        APP_BUNDLE="build/darwin/${APP_NAME}.app"
        mkdir -p "$APP_BUNDLE/Contents/MacOS"
        mkdir -p "$APP_BUNDLE/Contents/Resources"
        
        # Build
        CGO_ENABLED=1 GOOS=darwin GOARCH=${{ matrix.arch }} go build -o "$APP_BUNDLE/Contents/MacOS/game_client" .
        
        # Copy resources
        cp resources/Info.plist "$APP_BUNDLE/Contents/"
        cp resources/app.icns "$APP_BUNDLE/Contents/Resources/"
        chmod +x "$APP_BUNDLE/Contents/MacOS/game_client"
        
        # Create DMG
        DMG_DIR="build/darwin/dmg"
        mkdir -p "$DMG_DIR"
        cp -R "$APP_BUNDLE" "$DMG_DIR/"
        ln -s /Applications "$DMG_DIR/Applications"
        
        DMG_NAME="OandM_Game_Room_${VERSION}_${{ matrix.name }}.dmg"
        hdiutil create -volname "$APP_NAME" -srcfolder "$DMG_DIR" -ov -format UDZO "build/darwin/$DMG_NAME"
        
        # Upload artifact
        echo "DMG_PATH=build/darwin/$DMG_NAME" >> $GITHUB_ENV
    
    - name: Upload DMG
      uses: actions/upload-artifact@v3
      with:
        name: macos-${{ matrix.name }}
        path: ${{ env.DMG_PATH }}

  create-release:
    name: Create Release
    needs: build-macos
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        path: ./artifacts
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## O&M Game Room Release
          
          ### macOS Downloads
          - Intel Macs: Download the `intel` DMG
          - Apple Silicon Macs: Download the `apple_silicon` DMG
          
          ### Installation
          1. Download the appropriate DMG for your Mac
          2. Open the DMG file
          3. Drag "O&M Game Room" to your Applications folder
          4. Launch from Applications or Spotlight
          
          ### What's New
          - See commit history for changes
        draft: false
        prerelease: false
    
    - name: Upload Release Assets
      run: |
        for file in artifacts/*/*; do
          if [[ -f "$file" ]]; then
            asset_name=$(basename "$file")
            echo "Uploading $asset_name"
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$file" \
              "${{ steps.create_release.outputs.upload_url }}?name=$asset_name"
          fi
        done