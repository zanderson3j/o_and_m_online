name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    name: Build macOS
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-latest  # Latest macOS (Apple Silicon)
            arch: arm64
            name: apple_silicon
          - os: macos-15-intel  # Intel runner (free for public repos)
            arch: amd64
            name: intel
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Build for ${{ matrix.name }}
      env:
        MACOSX_DEPLOYMENT_TARGET: "10.13"
      run: |
        APP_NAME="O&M Game Room"
        VERSION=${GITHUB_REF#refs/tags/v}

        # Create app bundle
        APP_BUNDLE="build/darwin/${APP_NAME}.app"
        mkdir -p "$APP_BUNDLE/Contents/MacOS"
        mkdir -p "$APP_BUNDLE/Contents/Resources"

        # Build (let Go detect the architecture)
        go build -o "$APP_BUNDLE/Contents/MacOS/game_client" .
        
        # Copy resources
        cp resources/Info.plist "$APP_BUNDLE/Contents/"
        cp resources/app.icns "$APP_BUNDLE/Contents/Resources/"
        chmod +x "$APP_BUNDLE/Contents/MacOS/game_client"
        
        # Ad-hoc sign the app
        codesign --force --deep --sign - "$APP_BUNDLE"
        
        # Create DMG
        DMG_DIR="build/darwin/dmg"
        mkdir -p "$DMG_DIR"
        cp -R "$APP_BUNDLE" "$DMG_DIR/"
        ln -s /Applications "$DMG_DIR/Applications"
        
        DMG_NAME="OandM_Game_Room_${VERSION}_${{ matrix.name }}.dmg"
        hdiutil create -volname "$APP_NAME" -srcfolder "$DMG_DIR" -ov -format UDZO "build/darwin/$DMG_NAME"
        
        # Upload artifact
        echo "DMG_PATH=build/darwin/$DMG_NAME" >> $GITHUB_ENV
    
    - name: Upload DMG
      uses: actions/upload-artifact@v4
      with:
        name: macos-${{ matrix.name }}
        path: ${{ env.DMG_PATH }}

  create-release:
    name: Create Release
    needs: build-macos
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*/*
        body: |
          ## O&M Game Room Release

          ### macOS Downloads
          - **Intel Macs**: Download the `intel` DMG
          - **Apple Silicon Macs** (M1/M2/M3): Download the `apple_silicon` DMG

          ### Installation
          1. Download the appropriate DMG for your Mac
          2. Open the DMG file
          3. Drag "O&M Game Room" to your Applications folder
          4. Launch and enjoy!

          **Note**: This app is currently unsigned. On first launch, you may need to right-click the app and select "Open" to bypass Gatekeeper security.

          ### What's New
          See release notes below for changes in this version.
        draft: false
        prerelease: false